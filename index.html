<script>
  function generate() {
    const teks = document.getElementById('input').value.trim();
    if (!teks) {
      alert('Isi dulu linknya bro!');
      return;
    }

    const lines = teks.split('\n').filter(l => l.trim() !== '');
    let output = '';

    lines.forEach((line, idx) => {
      let raw = line.trim();
      let id = null;

      // Parsing lebih longgar & case-insensitive
      raw = raw.replace(/^http:\/\//i, 'https://');
      if (!raw.startsWith('https://')) raw = 'https://' + raw;

      try {
        const url = new URL(raw);

        // Case 1: ?id=xxxx
        id = url.searchParams.get('id');

        // Case 2: /v/xxxx
        if (!id) {
          const path = url.pathname.toLowerCase();
          if (path.startsWith('/v/')) {
            id = path.split('/v/')[1].split('?')[0].split('/')[0];
          }
        }

        // Case 3: cdn.videy.co/xxxx.mp4
        if (!id && url.hostname.includes('videy.co') && raw.endsWith('.mp4')) {
          id = raw.split('/').pop().replace(/\.mp4$/i, '');
        }

        // Case 4: kalau input langsung ID panjang >=5
        if (!id && raw.length >= 5 && /^[a-zA-Z0-9_-]+$/.test(raw)) {
          id = raw;
        }

      } catch (e) {
        // Gagal parse URL, coba manual split
        if (raw.includes('videy.co')) {
          const parts = raw.split(/[\?\/]/);
          id = parts.find(p => p.length >= 5 && /^[a-zA-Z0-9]+$/.test(p));
        }
      }

      if (id && id.length >= 5) {
        const link = window.location.origin + window.location.pathname + '?v=' + id;
        output += `
          <div class="bg-gray-900 p-3 rounded relative mb-2">
            <p class="break-all text-blue-300 text-sm">${link}</p>
            <button onclick="navigator.clipboard.writeText('${link}').then(()=>alert('Link dicopy!')).catch(()=>alert('Gagal copy, select manual'))" 
                    class="absolute top-2 right-2 bg-blue-700 px-3 py-1 rounded text-xs text-white">
              Copy
            </button>
          </div>`;
      } else {
        output += `<div class="bg-red-900 p-3 rounded text-sm">Baris \( {idx+1}: Gagal ekstrak ID dari " \){raw}"</div>`;
      }
    });

    if (output) {
      document.getElementById('daftar').innerHTML = output;
      document.getElementById('hasil').classList.remove('hidden');
    } else {
      alert('Tidak ada ID valid yang ditemukan dari link yang kamu paste.');
    }
  }

  function reset() {
    document.getElementById('input').value = '';
    document.getElementById('hasil').classList.add('hidden');
    document.getElementById('daftar').innerHTML = '';
  }
</script>
